{% extends "base.html" %}

{% block title %}{{ event.title }} - Admin View{% endblock %}

{% block extra_css %}
<style>
.event-admin-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
}

.event-admin-header {
    grid-column: 1 / -1;
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.event-admin-header h2 {
    margin-bottom: 1rem;
}

.event-info {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.info-item {
    background: var(--light);
    padding: 1rem;
    border-radius: 6px;
}

.info-item strong {
    color: var(--primary);
}

.contributions-section {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.stats-sidebar {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    height: fit-content;
    position: sticky;
    top: 100px;
}

.stats-sidebar h3 {
    margin-bottom: 1rem;
    color: var(--primary);
}

.stat-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
}

.stat-item:last-child {
    border-bottom: none;
}

.stat-item strong {
    color: var(--success);
}

@media (max-width: 768px) {
    .event-admin-container {
        grid-template-columns: 1fr;
    }

    .stats-sidebar {
        position: static;
    }

    .event-info {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="event-admin-container">
    <div class="event-admin-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>{{ event.title }}</h2>
            <a href="{{ url_for('admin.edit_event', event_id=event.id) }}" class="btn btn-primary">Edit Event</a>
        </div>

        <div class="event-info">
            <div class="info-item">
                <strong>Organizer:</strong>
                <p>{{ event.organizer_name }}</p>
            </div>
            <div class="info-item">
                <strong>Contact:</strong>
                <p>{{ event.organizer_phone }}</p>
            </div>
            <div class="info-item">
                <strong>Type:</strong>
                <p>{{ event.event_type.value.upper() }}</p>
            </div>
            <div class="info-item">
                <strong>Status:</strong>
                <p>{{ event.status.upper() }}</p>
            </div>
        </div>

        <p style="margin-top: 1rem; color: var(--secondary);">{{ event.description }}</p>
    </div>

    <div class="contributions-section">
        <h3>Contributions ({{ contributions|length }})</h3>
        
        {% if contributions %}
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Contributor</th>
                        <th>Phone</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contrib in contributions|reverse %}
                    <tr>
                        <td>{{ contrib.contributor_name }}</td>
                        <td>{{ contrib.contributor_phone }}</td>
                        <td><strong>KES {{ "{:,.0f}".format(contrib.amount) }}</strong></td>
                        <td><span class="badge {{ contrib.status }}">{{ contrib.status }}</span></td>
                        <td>{{ contrib.created_at.strftime('%d %b %Y %H:%M') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No contributions yet</p>
        {% endif %}
    </div>

    <div class="expenditure-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3>Expenditures ({{ expenditures|length }})</h3>
            <a href="{{ url_for('admin.add_expenditure', event_id=event.id) }}" class="btn btn-primary btn-small">+ Add Expenditure</a>
        </div>
        
        {% if expenditures %}
            <div class="expenditure-summary" style="background: var(--light); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div>
                        <small>Total Expenditure</small>
                        <strong style="color: var(--danger);">KES {{ "{:,.0f}".format(total_expenditure) }}</strong>
                    </div>
                    <div>
                        <small>Remaining Balance</small>
                        <strong style="color: var(--success);">KES {{ "{:,.0f}".format(remaining) }}</strong>
                    </div>
                    <div>
                        <small>Budget Used</small>
                        <strong>{{ "{:.1f}".format((total_expenditure / event.current_amount * 100) if event.current_amount > 0 else 0) }}%</strong>
                    </div>
                </div>
            </div>

            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Approved By</th>
                        <th>Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for exp in expenditures|reverse %}
                    <tr>
                        <td>{{ exp.description }}</td>
                        <td><span class="badge category-{{ exp.category.value }}">{{ exp.category.value }}</span></td>
                        <td><strong>KES {{ "{:,.0f}".format(exp.amount) }}</strong></td>
                        <td>{{ exp.approved_by }}</td>
                        <td>{{ exp.created_at.strftime('%d %b %Y') }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('admin.delete_expenditure', expenditure_id=exp.id) }}" style="display: inline;">
                                <button type="submit" class="btn btn-danger btn-small" onclick="return confirm('Delete this expenditure?')">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No expenditures recorded yet. <a href="{{ url_for('admin.add_expenditure', event_id=event.id) }}">Add one</a></p>
        {% endif %}
    </div>

    <div class="stats-sidebar">
        <h3>Summary</h3>
        
        <div class="stat-item">
            <span>Total Raised:</span>
            <strong>KES {{ "{:,.0f}".format(event.current_amount) }}</strong>
        </div>
        
        <div class="stat-item">
            <span>Target:</span>
            <strong>KES {{ "{:,.0f}".format(event.target_amount) }}</strong>
        </div>
        
        <div class="stat-item">
            <span>Progress:</span>
            <strong>{{ "{:.1f}".format((event.current_amount / event.target_amount * 100) if event.target_amount > 0 else 0) }}%</strong>
        </div>

        <div class="progress-bar" style="margin: 1rem 0;">
            <div class="progress-fill" style="width: {{ (event.current_amount / event.target_amount * 100) if event.target_amount > 0 else 0 }}%"></div>
        </div>
        
        <hr style="margin: 1rem 0;">

        <div class="stat-item">
            <span>Total Expenditure:</span>
            <strong style="color: var(--danger);">KES {{ "{:,.0f}".format(total_expenditure) }}</strong>
        </div>

        <div class="stat-item">
            <span>Remaining Balance:</span>
            <strong style="color: var(--success);">KES {{ "{:,.0f}".format(remaining) }}</strong>
        </div>

        <div class="stat-item">
            <span>Expenditure %:</span>
            <strong>{{ "{:.1f}".format((total_expenditure / event.current_amount * 100) if event.current_amount > 0 else 0) }}%</strong>
        </div>
        
        <div class="stat-item">
            <span>Contributors:</span>
            <strong>{{ contributions|length }}</strong>
        </div>

        <div class="stat-item">
            <span>Created:</span>
            <small>{{ event.created_at.strftime('%d %b %Y') }}</small>
        </div>

        <a href="{{ url_for('main.event_detail', event_id=event.id) }}" class="btn btn-primary btn-large" style="margin-top: 1rem;">View Public Page</a>
    </div>
</div>
{% endblock %}
